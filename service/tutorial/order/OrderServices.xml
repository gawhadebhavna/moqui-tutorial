<?xml version="1.0" encoding="UTF-8"?>
<services xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
          xsi:noNamespaceSchemaLocation="http://moqui.org/xsd/service-definition-2.1.xsd">

    <service verb="get" noun="FemalePersons">
        <description>
            Person records for all females
        </description>
        <out-parameters>
            <parameter name="orderList" type="list"/>
        </out-parameters>
        <actions>
            <entity-find entity-name="mantle.party.Person" list="orderList">
                <econdition field-name="gender" value="F"/>
            </entity-find>
        </actions>
    </service>

    <service verb="get" noun="Persons">
        <description>
            List the Person details with MarsMarried marital status
        </description>
        <out-parameters>
            <parameter name="orderList" type="list"/>
        </out-parameters>
        <actions>
            <entity-find entity-name="mantle.party.Person" list="orderList">
                <econdition field-name="maritalStatusEnumId" value="MarsMarried"/>
            </entity-find>
        </actions>
    </service>

    <service verb="get" noun="LatestOrders">
        <description>
            Find all Order Header records so that the latest placed order appears at the top
        </description>
        <out-parameters>
            <parameter name="orderList" type="List"/>
        </out-parameters>
        <actions>
            <entity-find entity-name="orders" list="orderList">
                <order-by field-name="-placedDate"/>
            </entity-find>
        </actions>
    </service>

    <service verb="get" noun="Order">
        <description>
            Find the Order Header details for a given orderId.
        </description>
        <in-parameters>
            <parameter name="orderId" required="true"/>
        </in-parameters>
        <out-parameters>
            <parameter name="orderDetails" type="List"/>
        </out-parameters>
        <actions>
            <entity-find entity-name="orders" list="orderDetails">
                <econdition field-name="orderId"/>
            </entity-find>
        </actions>
    </service>

    <service verb="get" noun="OrderHeaders">
        <description>
            Find all Order Header records with the grandTotal greater than 50
        </description>
        <out-parameters>
            <parameter name="orderHeaderDetails"/>
        </out-parameters>
        <actions>
            <entity-find entity-name="orders" list="orderHeaderDetails">
                <econdition field-name="grandTotal" operator="greater" value="50"/>
            </entity-find>
        </actions>
    </service>

    <service verb="get" noun="OrderItems">
        <description>
            List all Order Item details for the order with orderId, 100102 and orderPartSeqId, 01
        </description>
        <out-parameters>
            <parameter name="orderItemDetails"/>
        </out-parameters>
        <actions>
            <entity-find entity-name="orderItems" list="orderItemDetails">
                <econdition field-name="orderId" value="100102"/>
                <econdition field-name="orderPartSeqId" value="01"/>
            </entity-find>
        </actions>
    </service>

    <service verb="get" noun="OrderParts">
        <description>
            Find all Order Parts with partTotal less than equals to 20.
        </description>
        <out-parameters>
            <parameter name="orderPartDetails"/>
        </out-parameters>
        <actions>
            <entity-find entity-name="orderParts" list="orderPartDetails">
                <econdition field-name="partTotal" operator="less-equals" value="20"/>
            </entity-find>
        </actions>
    </service>

    <service verb="get" noun="OrderPartData">
        <description>
            Find all Order Part records assigned to the facility with ZIRET_WH value
        </description>
        <out-parameters>
            <parameter name="orderPartDetails" type="list"/>
        </out-parameters>
        <actions>
            <entity-find entity-name="orderParts" list="orderList">
                <econdition field-name="facilityId" value="ZIRET_WH"/>
            </entity-find>
            <set field="orderPartDetails" value="[]"/>
            <iterate list="orderList" entry="part">
                <set field="facilityId" from="part.facilityId"/>
                <set field="partMap" from="[orderId:part.orderId,facilityId:facilityId]"/>
                <set field="orderPartDetails" from="orderPartDetails+partMap"/>
            </iterate>
        </actions>
    </service>

    <service verb="get" noun="OrderPartsCount">
        <description>
            Find the count of order parts for the customer Party Id, “CustJqp”
        </description>
        <out-parameters>
            <parameter name="orderPartsCount"/>
        </out-parameters>
        <actions>
            <entity-find-count entity-name="orderParts" count-field="orderPartsCount">
                <econdition field-name="customerPartyId" value="CustJqp"/>
            </entity-find-count>
        </actions>
    </service>

    <service verb="get" noun="OrderPartsInfo">
        <description>
            Find all unique Order Parts with shipmentMethodEnumId value as “ShtMthGround” and facilityId as “ZIRET_WH”
        </description>
        <out-parameters>
            <parameter name="orderPartsList"/>
        </out-parameters>
        <actions>
            <entity-find entity-name="orderParts" list="orderPartsList" distinct="true">
                <econdition field-name="shipmentMethodEnumId" value="ShtMthGround"/>
                <econdition field-name="facilityId" value="ZIRET_WH"/>
            </entity-find>
        </actions>
    </service>
    <!-- create order here -->
    <service verb="create" noun="OrderHeader">
        <description>
            This service will create the Order_Header detail.
        </description>
        <in-parameters>
            <parameter name="orderName" required="true"/>
            <parameter name="currencyUomId" default-value="USD"/>
            <parameter name="salesChannelEnumId"/>
            <parameter name="statusId" default-value="orderPlaced"/>
            <parameter name="placedDate" required="true"/>
            <parameter name="productStoreId"/>
            <parameter name="approvedDate"/>
        </in-parameters>
        <out-parameters>
            <parameter name="orderId" required="true"/>
        </out-parameters>
        <actions>
            <service-call name="create#mantle.order.OrderHeader" in-map="context" out-map="context"/>
        </actions>
    </service>
    <!-- create orderPart here -->
    <service verb="create" noun="OrderPart">
        <description>
            This service will create OrderPart data
        </description>
        <in-parameters>
            <parameter name="orderId" required="true"/>
            <parameter name="partName"/>
            <parameter name="facilityId" required="true"/>
            <parameter name="shipmentMethodEnumId"/>
            <parameter name="customerPartyId" required="true"/>
            <parameter name="item_details" type="List">
                <parameter name="itemMap" type="Map">
                    <parameter name="productId"/>
                    <parameter name="itemDescription"/>
                    <parameter name="quantity"/>
                    <parameter name="unitAmount"/>
                </parameter>
            </parameter>
        </in-parameters>
        <out-parameters>
            <parameter name="orderId"/>
            <parameter name="orderPartSeqId"/>
        </out-parameters>
        <actions>
            <service-call name="create#mantle.order.OrderPart" in-map="context" out-map="context"/>
            <iterate list="item_details" entry="orderItem">
                <service-call name="create#mantle.order.OrderItem" in-map="[orderId:context.orderId,orderPartSeqId:context.orderPartSeqId,
                                    productId:orderItem.productId,itemDescription:orderItem.itemDescription,quantity:orderItem.quantity,
                                    unitAmount:orderItem.unitAmount]" out-map="context"/>
            </iterate>
        </actions>
    </service>
    <!-- get one order detail here by orderId -->
    <service verb="get" noun="ReturnOrderInfo">
        <in-parameters>
            <parameter name="orderId"/>
        </in-parameters>
        <out-parameters>
            <parameter name="order" type="List">
                <parameter name="orderMap" type="Map">
                    <parameter name="orderId"/>
                    <parameter name="orderName"/>
                    <parameter name="currencyUom"/>
                    <parameter name="salesChannelEnumId"/>
                    <parameter name="statusId"/>
                    <parameter name="placedDate"/>
                    <parameter name="grandTotal"/>
                    <parameter name="customer_details" type="List">
                        <parameter name="customerMap" type="Map">
                            <parameter name="customerPartyId"/>
                            <parameter name="firstName"/>
                            <parameter name="middleName"/>
                            <parameter name="lastName"/>
                        </parameter>
                    </parameter>
                    <parameter name="order_parts" type="List">
                        <parameter name="partMap" type="Map">
                            <parameter name="orderPartSeqId"/>
                            <parameter name="partName"/>
                            <parameter name="facilityId"/>
                            <parameter name="shipmentMethodEnumId"/>
                            <parameter name="partStatusId"/>
                            <parameter name="partTotal"/>
                            <parameter name="item_details" type="List">
                                <parameter name="itemMap" type="Map">
                                    <parameter name="orderItemSeqId"/>
                                    <parameter name="productId"/>
                                    <parameter name="itemDescription"/>
                                    <parameter name="quantity"/>
                                    <parameter name="unitAmount"/>
                                </parameter>
                            </parameter>
                        </parameter>
                    </parameter>
                </parameter>
            </parameter>
        </out-parameters>
        <actions>
            <!--1.Fetch data from orderHeader table -->
            <entity-find-one entity-name="mantle.order.OrderHeader" value-field="order_detail">
                <field-map field-name="orderId"/>
            </entity-find-one>
            <set field="order" from="[]"/>
            <!--2. fetch data from orderPart -->
            <entity-find entity-name="mantle.order.OrderPart" list="order_parts">
                <econdition field-name="orderId"/>
            </entity-find>
            <!--3.here setting customerPartyId for use in list customerDetails-->
            <set field="customerPartyId" from="order_parts.customerPartyId"/>
            <!--4. fetch data from person table -->
            <entity-find-one entity-name="mantle.party.Person" value-field="customer_details">
                <field-map field-name="partyId" from="customerPartyId"/>
            </entity-find-one>
            <!--5 setting fields value in map -->
            <set field="customerMap" from="[customerPartyId:customer_details.partyId,firstName:customer_details.firstName,
                                           middleName:customer_details.middleName,lastName:customer_details.lastName]"/>
            <set field="partList" from="[]"/>
            <!-- 6.emptyList to store the item details -->
            <set field="itemList" from="[]"/>
            <!-- 7. traversing data from orderPart table -->
            <iterate list="order_parts" entry="part">
                <!-- 8.store orderPartSeqId for fetch item_details -->
                <set field="orderPartSeqId" from="part.orderPartSeqId"/>
                <!-- 9.Fetch data from orderItem table-->
                <entity-find entity-name="mantle.order.OrderItem" list="item_details">
                    <econdition field-name="orderId"/>
                    <econdition field-name="orderPartSeqId"/>
                </entity-find>
                <!-- 10. traversing Item_details here -->
                <iterate list="item_details" entry="item">
                    <set field="itemMap" from="[orderItemSeqId:item.orderItemSeqId,productId:item.productId,itemDescription:item.itemDescription,
                                               quantity:item.quantity,unitAmount:item.unitAmount]"/>
                    <script>itemList.add(itemMap)</script>
                </iterate>
                <!-- 11.set partMap from orderPart here -->
                <set field="partMap" from="[orderPartSeqId:part.orderPartSeqId,partName:part.partName,facilityId:part.facilityId,
                                               shipmentMethodEnumId:part.shipmentMethodEnumId,partStatusId:part.statusId,partTotal:part.partTotal,item_details:itemList]"/>
                <script>partList.add(partMap)</script>
                <!-- 12 set orderMap from orderHeader,customer_details,OrderPart -->
                <set field="orderMap" from="[orderId:order_detail.orderId,orderName:order_detail.orderName,currencyUom:order_detail.currencyUom.uomId,
                                             salesChannelEnumId:order_detail.salesChannelEnumId,statusId:order_detail.statusId,placedDate:order_detail.placedDate,
                                             grandTotal:order_detail.grandTotal,customer_details:customerMap,order_parts:partList]"/>
            </iterate>
            <script>order.add(orderMap)</script>
        </actions>
    </service>
    <!-- get all order details here  -->
    <service verb="get" noun="ReturnAllOrders">
        <out-parameters>
            <parameter name="orders" type="List">
                <parameter name="orderMap" type="Map">
                    <parameter name="orderId"/>
                    <parameter name="orderName"/>
                    <parameter name="currencyUom"/>
                    <parameter name="salesChannelEnumId"/>
                    <parameter name="statusId"/>
                    <parameter name="placedDate"/>
                    <parameter name="grandTotal"/>
                    <parameter name="customer_details" type="List">
                        <parameter name="customerMap" type="Map">
                            <parameter name="customerPartyId"/>
                            <parameter name="firstName"/>
                            <parameter name="middleName"/>
                            <parameter name="lastName"/>
                        </parameter>
                    </parameter>
                    <parameter name="order_parts" type="List">
                        <parameter name="partMap" type="Map">
                            <parameter name="orderPartSeqId"/>
                            <parameter name="partName"/>
                            <parameter name="facilityId"/>
                            <parameter name="shipmentMethodEnumId"/>
                            <parameter name="partStatusId"/>
                            <parameter name="partTotal"/>
                            <parameter name="item_details" type="List">
                                <parameter name="itemMap" type="Map">
                                    <parameter name="orderItemSeqId"/>
                                    <parameter name="productId"/>
                                    <parameter name="itemDescription"/>
                                    <parameter name="quantity"/>
                                    <parameter name="unitAmount"/>
                                </parameter>
                            </parameter>
                        </parameter>
                    </parameter>
                </parameter>
            </parameter>
        </out-parameters>
        <actions>
            <!-- Fetch data from orderHeader -->
            <entity-find entity-name="mantle.order.OrderHeader" list="orderList">

            </entity-find>
            <set field="orders" from="[]"/>
            <set field="order_parts" from="[]"/>
            <set field="order_items" from="[]"/>
            <!--traversing data from orderList -->
            <iterate list="orderList" entry="order">

                <!-- store orderId for fetch data from orderPart -->
                <set field="orderId" from="order.orderId"/>
                <entity-find entity-name="mantle.order.OrderPart" list="parts">
                    <econdition field-name="orderId" from="order.orderId"/>
                </entity-find>
                <!-- store customerPartyId for fetch data from person table -->
                <set field="partyId" from="parts.customerPartyId"/>
                <iterate list="parts" entry="part">
                    <!-- set orderPartSeqId here for fetch data from orderItem table -->
                    <set field="orderPartSeqId" from="part.orderPartSeqId"/>
                    <entity-find entity-name="mantle.order.OrderItem" list="items">
                        <econdition field-name="orderId"/>
                        <econdition field-name="orderPartSeqId"/>
                    </entity-find>
                    <!-- traverse the data from orderItem -->
                    <iterate list="items" entry="item">
                        <set field="itemMap" from="[orderItemSeqId:item.orderItemSeqId,productId:item.productId,itemDescription:item.itemDescription,
                                               quantity:item.quantity,unitAmount:item.unitAmount]"/>

                        <script>order_items.add(itemMap)</script>
                    </iterate>
                    <!-- set orderPart detail here in Map -->
                    <set field="partMap" from="[orderPartSeqId:part.orderPartSeqId,partName:part.partName,facilityId:part.facilityId,
                                               shipmentMethodEnumId:part.shipmentMethodEnumId,partStatusId:part.statusId,partTotal:part.partTotal,
                                               item_details:order_items]"/>
                    <script>order_parts.add(partMap)</script>
                </iterate>
                <!-- Find customer_details here by PartyId == CustomerPartyId -->
                <entity-find-one entity-name="mantle.party.Person" value-field="customer_details">
                    <field-map field-name="partyId"/>
                </entity-find-one>
                <set field="customerMap" from="[customerPartyId:customer_details.partyId,firstName:customer_details.firstName,
                                           middleName:customer_details.middleName,lastName:customer_details.lastName]"/>
                <!-- set Order details here in Map -->
                <set field="orderMap" from="[orderId:order.orderId,orderName:order.orderName,currencyUom:order.currencyUom.uomId,
                                             salesChannelEnumId:order.salesChannelEnumId,statusId:order.statusId,placedDate:order.placedDate,
                                             grandTotal:order.grandTotal,customer_details:customerMap,order_parts:order_parts]"/>
                <script>orders.add(orderMap)</script>
            </iterate>
        </actions>
    </service>


</services>
